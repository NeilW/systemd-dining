name: Build Release

concurrency: deployment

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  mkosi-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: setup-mkosi
        uses: systemd/mkosi@v19
      - name: Build image
        run: mkosi
      - name: Rename SHA256
        run: mv philosophers.SHA256SUMS SHA256SUMS
      - name: Run Release
        id: release
        uses: "marvinpinto/action-automatic-releases@v1"
        with:
          repo_token: ${{ github.token }}
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Build"
          files: |
            philosophers.tar.xz
            philosophers.nspawn
            SHA256SUMS
