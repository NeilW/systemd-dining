#!/bin/sh
set -e

count() {
    case ${1##*/} in
        \*)
            echo 0
            ;;
        *)
            echo $#
            ;;
    esac
}

# ask_for_fork fork_num
ask_for_fork() {
    if [ ! -w "${1}" ]
    then
        echo "I don't have fork #${2}"
        if [ -e "${1}" ]
        then
            request-fork "$(stat --format=%U "${1}")"
        else
            echo "and it is missing (response in transit)"
        fi
    fi
}

diningroom=/home/share/dining-room
forkarea=${diningroom}/forks
base=10

lfork=$(my-dining-seat)
max=$(count ${diningroom}/seats/*)
max=$((max + base))
rfork=$((lfork + 1))
if [ "${rfork}" -gt "${max}" ]
then
    rfork=$((base + 1))
fi

ask_for_fork "${forkarea}/${lfork}" "${lfork}"
ask_for_fork "${forkarea}/${rfork}" "${rfork}"
